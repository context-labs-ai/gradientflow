# GradientFlow 可增强特性与可替换方案清单

> 基于当前架构（Express + React + lowdb JSON 持久化、RAG/MCP/Agent 服务拆分），按用户体验、Agent/LLM 能力、系统工程三个维度梳理可落地的增强点与替换方案。便于在迭代前快速评估优先级。

## 用户体验与协作
- **上下文可视化**：在聊天侧边栏增加「上下文包」(pinned context packs)，将选中消息、RAG 摘要、Agent 配置组合为一次性注入的上下文，支持分享与复用。
- **线程化与引用视图**：对长对话引入可折叠子线程，引用消息 hover 时展示原文卡片；支持按引用链自动生成对话地图，方便回溯。
- **知识库预览与权限标签**：上传文档后生成要点摘要卡片，标注访问范围（私有/空间/全局），避免误用敏感资料。
- **Agent 侧边快捷操作**：为常用 Agent 提供快捷按钮（总结、提炼 Action Items、生成会议纪要），减少手动提示词编写。
- **多模态入口**：在输入区添加图片/截图上传入口，结合本地多模态模型完成 OCR 与描述生成，提升报告和演示素材整理效率。

## Agent / LLM 能力
- **工具链监控面板**：在消息详情里展示工具调用时间线（调用顺序、耗时、输出片段），并支持下载 JSON Trace，便于复现。
- **LLM/Eval 沙箱**：增加「评测模式」会话，允许同一提示在不同模型或参数上对比输出，配合简易的评分模板收集反馈，指导默认模型选择。
- **RAG 质量护栏**：引入检索质量信号（Top-K 命中文档标题、相似度阈值），当检索不足时自动 fallback 至纯模型回答或提示用户补充资料。
- **会话安全策略**：支持为 Agent 配置最大轮次、最大 Token、敏感词审计规则；当规则触发时自动打标并阻断输出片段。
- **主动型 Agent**：允许 Agent 订阅特定关键字或数据源（如 RAG 更新事件），在满足条件时自动插入信息或提醒，提升协作密度。

## 系统与部署工程
- **持久化替换**：将 lowdb JSON 存储迁移到 SQLite + Prisma，获得事务与并发安全，便于后续拓展到 Postgres；同时保留轻量级本地部署体验。
- **实时通道升级**：将部分 SSE 推送改为 WebSocket（消息、输入状态、Agent 运行状态），提升并发性能并简化客户端重连逻辑。

### WebSocket 选型与迁移指引
- **适用场景**：如果需要在同一连接上承载多路事件（消息列表、输入状态、Agent 工况心跳）或双向交互（例如「用户撤回消息」「Agent 主动插话」），优先选用 WebSocket；纯下行、事件单一且对防火墙穿透敏感的场景可继续保留 SSE。
- **协议约定**：定义轻量事件格式 `{ type, sessionId, payload, ts }`，客户端按 `sessionId` 归档；为兼容现有 SSE，保持事件体与 HTTP 接口结构一致，减少前端改动面。
- **回退策略**：初始化连接时发送 `hello` 事件协商版本号与心跳间隔（如 20s）；若心跳 2 个周期缺失或 101 升级失败则自动降级到 SSE，并在 UI 提示“实时通道已降级”。
- **服务端落地**：在 `server` 层新增 `/ws` 端点（基于 Express + ws），复用现有会话鉴权中间件；按会话房间维护连接集合并暴露 `broadcastMessage`/`broadcastAgentStatus` 等 helper，保持向后兼容。
- **客户端接入**：在 React 客户端抽象 `useRealtimeChannel` hook，内部优先尝试 WebSocket 并暴露统一的 `onMessage`、`send`、`status` API；降级 SSE 时 hook 内部切换实现，无需上层组件改动。
- **配置分层**：为各服务提供统一的 `.env.example` 与分环境配置（dev/stage/prod），并集中校验必填项（如 RAG/MCP/Agent 端口、密钥）。
- **可观测性与审计**：为后端增加结构化日志（request id、用户 id、会话 id），并提供简单的 metrics 端点（p95 延迟、工具失败率），便于部署到可观测平台。
- **部署替代方案**：除了 Railway 部署，补充 Docker Compose 一键方案（前端 + API + RAG + MCP + Agent 服务），支持 GPU 节点透传与本地开发快启。

## 快速取舍建议
- **优先级高**：上下文包、工具链监控面板、RAG 质量护栏（直接改善体验与可靠性）。
- **中期**：SQLite/Prisma 迁移、WebSocket 通道、LLM/Eval 沙箱（提升工程与评测能力）。
- **长期**：主动型 Agent、多模态入口、完整可观测性/审计（需要更多基础设施投入）。
